{% extends 'base.html' %}
{% block content %}
<style>
  :root{ --sbw:240px; }
  #admin-root{ min-height: calc(100vh - 64px); }
  #sidebar{ width: var(--sbw); }

  /* Fondo dark del sidebar con gradiente sutil */
  #sidebar{
    background: linear-gradient(180deg,#0b1222,#0a1426 55%,#0b1728);
    border-right: 1px solid rgba(148,163,184,.12);
  }

  /* Nav items */
  .nav-item{
    position:relative;
    display:flex; align-items:center; gap:.75rem;
    padding:.625rem .75rem;
    border-radius:.75rem;
    color:#cbd5e1; text-decoration:none;
    transition: background .15s ease, color .15s ease, transform .05s ease;
  }
  .nav-item .icon{
    width:34px; height:34px; border-radius:.75rem;
    display:grid; place-items:center;
    background: rgba(255,255,255,.06);
  }
  .nav-item:hover{ background: rgba(255,255,255,.06); }
  .nav-item.active{
    background: rgba(16,185,129,.12);
    color:#34d399;
  }
  .nav-label, .brand-label{ transition: opacity .15s ease, width .15s ease, margin .15s ease; }

  /* Colapso del sidebar */
  #admin-root.sb-collapsed{ --sbw:84px; }
  #admin-root.sb-collapsed .nav-label,
  #admin-root.sb-collapsed .brand-label{
    opacity:0; width:0; margin:0; overflow:hidden;
  }

  /* Tooltip al estar colapsado */
  #admin-root.sb-collapsed .nav-item:hover::after{
    content: attr(data-title);
    position:absolute; left: calc(100% + 8px); top:50%; transform: translateY(-50%);
    background:#0f172a; color:#e2e8f0; border:1px solid rgba(148,163,184,.2);
    padding:.35rem .55rem; border-radius:.5rem; white-space:nowrap;
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
    z-index:30; pointer-events:none;
    font-size:.85rem;
  }

  /* Handle para abrir/cerrar: siempre visible */
  .sb-handle{
    position:absolute; right:-12px; top:14px; width:26px; height:26px;
    border-radius:9999px; background:#059669; color:#fff; display:grid; place-items:center;
    box-shadow:0 6px 14px rgba(0,0,0,.35); cursor:pointer; font-weight:700; line-height:1;
  }

  /* Cards en dark */
  .card { border:1px solid rgba(148,163,184,.12); box-shadow: 0 18px 40px -25px rgba(2,44,34,.45); }
  .dark .card{ border-color: rgba(148,163,184,.20); box-shadow: 0 10px 18px -12px rgba(0,0,0,.5); }
</style>

<div id="admin-root" class="flex dark:text-slate-100">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="relative transition-all duration-200">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-emerald-500 text-white grid place-items-center font-extrabold">EQ</div>
          <div class="font-semibold brand-label">EconQuest Admin</div>
        </div>
      </div>

      <nav class="mt-6 space-y-2">
        <a class="nav-item {{ 'active' if request.endpoint=='admin.dashboard' else '' }}" data-title="Dashboard" href="{{ url_for('admin.dashboard') }}">
          <span class="icon">🏠</span><span class="nav-label">Dashboard</span>
        </a>
        <a class="nav-item {{ 'active' if request.endpoint=='admin.users_view' else '' }}" data-title="Users & Roles" href="{{ url_for('admin.users_view') }}">
          <span class="icon">👥</span><span class="nav-label">Users & Roles</span>
        </a>
        <a class="nav-item {{ 'active' if request.endpoint in ['admin.data_home','admin.data_table'] else '' }}" data-title="Data Browser" href="{{ url_for('admin.data_home') }}">
          <span class="icon">📁</span><span class="nav-label">Data Browser</span>
        </a>
        <a class="nav-item {{ 'active' if request.endpoint=='admin.sessions_live' else '' }}" data-title="Live Sessions" href="{{ url_for('admin.sessions_live') }}">
          <span class="icon">🟢</span><span class="nav-label">Live Sessions</span>
        </a>
      </nav>

      <div class="mt-6 text-xs text-slate-400 brand-label">
        Más tarde: ⚙️ Settings, 📊 Reports, 🔔 Alerts
      </div>
    </div>

    <!-- handle -->
    <button id="sb-handle" class="sb-handle"><span id="sb-icon">«</span></button>
  </aside>

  <!-- MAIN -->
  <section id="mainpane" class="flex-1 p-6 bg-slate-50 dark:bg-slate-950 transition-all duration-200">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for category, msg in messages %}
            <div class="p-3 rounded {{ 'bg-green-50 text-green-800 dark:bg-green-900/30 dark:text-green-300' if category=='success' else 'bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-300' }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block admin_content %}{% endblock %}
  </section>
</div>

<script>
    // Fuerza dark en admin
    document.documentElement.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  // tema (dark)
  (function(){
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') document.documentElement.classList.add('dark');
  })();


  // collapse sidebar
  const root = document.getElementById('admin-root');
  const handle = document.getElementById('sb-handle');
  const icon   = document.getElementById('sb-icon');

  function setCollapsed(v){
    if (v){ root.classList.add('sb-collapsed'); icon.textContent = '»'; }
    else  { root.classList.remove('sb-collapsed'); icon.textContent = '«'; }
    localStorage.setItem('sidebar-collapsed', v ? '1':'0');
  }
  handle.onclick = () => setCollapsed(!root.classList.contains('sb-collapsed'));
  if (localStorage.getItem('sidebar-collapsed') === '1') setCollapsed(true);

  // ping de presencia
  setInterval(()=>{ fetch("{{ url_for('admin.api_ping') }}",{method:"POST",headers:{'X-Requested-With':'fetch'}}) }, 20000);
</script>
{% endblock %}
