{% extends 'admin/layout.html' %}
{% block admin_content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-xl font-semibold">Live Sessions</h1>
  <div class="flex items-center gap-2">
    <button id="btn-refresh" class="px-3 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-slate-100">Refrescar</button>
    <a class="px-3 py-2 rounded bg-slate-200 dark:bg-slate-700 dark:text-slate-100" href="{{ url_for('admin.dashboard') }}">← Volver</a>
  </div>
</div>

<div id="live" class="bg-white dark:bg-slate-900 dark:text-slate-100 p-5 rounded-2xl shadow overflow-x-auto">
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm text-slate-500 dark:text-slate-400">
      Usuarios activos en los últimos 5 minutos
    </div>
    <div id="meta" class="text-xs text-slate-500 dark:text-slate-400"></div>
  </div>

  <table class="w-full text-sm">
    <thead class="text-slate-600 dark:text-slate-300">
      <tr class="text-left">
        <th>Usuario</th><th>Rol</th><th>Email</th><th>Desde</th><th>Último ping</th><th>IP</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="6" class="py-4 text-center text-slate-500 dark:text-slate-400">Cargando…</td></tr>
    </tbody>
  </table>
</div>

<script>
function fmtLocal(iso){
  // ISO -> fecha local breve
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  return d.toLocaleString();
}
async function loadSessions(){
  try{
    const res  = await fetch("{{ url_for('admin.api_active_sessions') }}");
    const data = await res.json();
    const tbody = document.getElementById("rows");
    const meta  = document.getElementById("meta");
    meta.textContent = `Actualizado: ${new Date().toLocaleTimeString()} · ${data.length} online`;

    if (!data.length){
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-slate-500 dark:text-slate-400">No hay sesiones activas.</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(s => `
      <tr class="border-t border-slate-200 dark:border-slate-700">
        <td>${s.name}</td>
        <td>${s.role}</td>
        <td>${s.email}</td>
        <td>${fmtLocal(s.login_at)}</td>
        <td>${fmtLocal(s.last_seen)}</td>
        <td>${s.ip ?? ''}</td>
      </tr>
    `).join('');
  }catch(e){
    document.getElementById("rows").innerHTML =
      `<tr><td colspan="6" class="py-4 text-center text-red-600">Error al cargar sesiones.</td></tr>`;
  }
}
document.getElementById('btn-refresh').onclick = loadSessions;
loadSessions(); setInterval(loadSessions, 20000);
</script>
{% endblock %}
