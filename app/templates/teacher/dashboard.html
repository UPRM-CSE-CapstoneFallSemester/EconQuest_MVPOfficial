{% extends 'teacher/layout.html' %}
{% block teacher_content %}

<div class="max-w-7xl mx-auto text-slate-900 dark:text-slate-100">

  <h1 class="text-2xl font-bold mb-4 text-emerald-400">Panel del docente</h1>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, msg in messages %}
          <div class="p-3 rounded {{ 'bg-emerald-900/30 text-emerald-200 border border-emerald-700/40' if category=='success' else 'bg-red-900/30 text-red-100 border border-red-700/40' }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ===== Módulos ===== #}
  <a id="modules"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Módulos</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear módulo</summary>
        <form method="post" action="{{ url_for('teacher.module_create') }}" class="mt-3 grid md:grid-cols-2 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" placeholder="Título" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="level" placeholder="Nivel (ej. 1)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="xp_reward" placeholder="XP (ej. 100)">
          <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published"> Publicado</label>
          <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="summary" placeholder="Resumen / objetivos"></textarea>
          <div class="md:col-span-2">
            <button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button>
          </div>
        </form>
      </details>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for m in modules %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ m.title }}</div>
              <div class="text-xs text-emerald-200/80">Nivel {{ m.level or 1 }} · +{{ m.xp_reward or 0 }} XP</div>
              <p class="mt-1 text-sm text-emerald-200/80">{{ m.summary or '' }}</p>
            </div>
            <div class="text-xs text-emerald-200/80">{{ 'Publicado' if m.is_published else 'Borrador' }}</div>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar</summary>

            <form method="post" action="{{ url_for('teacher.module_update', module_id=m.id) }}" class="mt-2 grid md:grid-cols-2 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" value="{{ m.title }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="level" value="{{ m.level or '' }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="xp_reward" value="{{ m.xp_reward or '' }}">
              <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published" {{ 'checked' if m.is_published else '' }}> Publicado</label>
              <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="summary">{{ m.summary or '' }}</textarea>
              <div class="md:col-span-2 flex items-center gap-2">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button>
              </div>
            </form>

            <form method="post" action="{{ url_for('teacher.module_delete', module_id=m.id) }}" onsubmit="return confirm('¿Eliminar módulo? Esto eliminará sus actividades.')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white">Eliminar</button>
            </form>
          </details>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay módulos aún.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Actividades ===== #}
  <a id="activities"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Actividades</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear actividad</summary>
        <form method="post" action="{{ url_for('teacher.activity_create') }}" class="mt-3 grid md:grid-cols-2 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
            <option value="">Selecciona módulo</option>
            {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
          </select>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" placeholder="Título" required>

          {# Type selector (no free text) #}
          <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="type" id="create-type">
            <option value="quiz" selected>quiz</option>
            <option value="scenario">scenario</option>
            <option value="text">text</option>
          </select>

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="max_points" placeholder="Puntos máx. (ej. 100)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="position" placeholder="Orden (ej. 1)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="attempt_limit" placeholder="Attempt limit (e.g., 3)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="default_xp" placeholder="Default XP (e.g., 25)" value="25">

          <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published"> Publicada</label>

          {# Hidden JSON field (auto-filled by JS) #}
          <input type="hidden" name="content_json" id="create-content-json">

          {# QUIZ editor (create) #}
          <div id="create-quiz-editor" class="mt-3 hidden md:col-span-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Questions</div>
              <button type="button" id="btn-create-add-question" class="px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600 text-white text-sm">+ Add question</button>
            </div>
            <div id="create-quiz-questions" class="mt-2 space-y-3"></div>
            <p class="text-xs text-emerald-300/80 mt-1">Add at least one option and mark one as correct.</p>
          </div>

          {# SCENARIO editor (create) #}
          <div id="create-scenario-editor" class="mt-3 hidden md:col-span-2">
            <label class="block text-sm mb-1">Prompt / Situation</label>
            <input type="text" id="create-scn-prompt" class="w-full rounded bg-slate-900 border border-slate-700 px-3 py-2" placeholder="Example: What is a fixed expense?">
            <div class="mt-3 flex items-center justify-between">
              <div class="text-sm font-semibold">Options</div>
              <div class="flex items-center gap-2">
                <select id="create-scn-preset" class="rounded bg-slate-900 border border-slate-700 px-2 py-1 text-sm">
                  <option value="">— insert from bank —</option>
                  <option value='{"label":"Monthly rent","delta":10}'>Monthly rent (+10)</option>
                  <option value='{"label":"Car payment","delta":8}'>Car payment (+8)</option>
                  <option value='{"label":"Eating out","delta":-5}'>Eating out (−5)</option>
                  <option value='{"label":"Impulse shopping","delta":-7}'>Impulse shopping (−7)</option>
                </select>
                <button type="button" id="btn-create-insert-preset" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-sm">Insert</button>
                <button type="button" id="btn-create-add-option" class="px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600 text-white text-sm">+ Add option</button>
              </div>
            </div>
            <div id="create-scn-options" class="mt-2 space-y-2"></div>
            <p class="text-xs text-emerald-300/80 mt-1">Each option has a numeric delta (positive = good, negative = bad).</p>
          </div>

          <div class="md:col-span-2">
            <button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button>
          </div>
        </form>
      </details>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for a in recent_activities %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="font-semibold text-emerald-100">{{ a.title }}</div>
          <div class="text-xs text-emerald-200/80">Tipo {{ a.type }} · Puntos {{ a.max_points or 0 }}</div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar</summary>

            <form method="post" action="{{ url_for('teacher.activity_update', activity_id=a.id) }}" class="mt-2 grid md:grid-cols-2 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" value="{{ a.title }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="type" value="{{ a.type }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="max_points" value="{{ a.max_points or '' }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="position" value="{{ a.position or '' }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="attempt_limit" value="{{ a.attempt_limit or '' }}" placeholder="Attempt limit">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="default_xp" value="{{ a.default_xp or '' }}" placeholder="Default XP">
              <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published" {{ 'checked' if a.is_published else '' }}> Publicada</label>

              {# Hidden JSON to submit #}
              <input type="hidden" name="content_json" id="edit-json-{{ a.id }}">

              {# Editor mount for this activity #}
              <div
                class="content-editor-mount md:col-span-2"
                data-activity-id="{{ a.id }}"
                data-atype="{{ a.type }}"
                data-initial='{{ a.content_json | safe }}'>
              </div>

              <div class="md:col-span-2">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button>
              </div>
            </form>

            <form method="post" action="{{ url_for('teacher.activity_delete', activity_id=a.id) }}" onsubmit="return confirm('¿Eliminar actividad?')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white">Eliminar</button>
            </form>
          </details>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay actividades aún.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Grupos ===== #}
  <a id="groups"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Grupos</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear grupo</summary>
        <form method="post" action="{{ url_for('teacher.group_create') }}" class="mt-3 grid md:grid-cols-3 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" placeholder="Nombre (p. ej. Finanzas 10-A)" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" placeholder="Grado (9-12)">
          <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button></div>
        </form>
      </details>
    </div>

    <div class="space-y-3">
      {% for g in groups %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ g.name }}</div>
              <div class="text-xs text-emerald-200/80">Grado {{ g.grade or '-' }}</div>
            </div>
            <form method="post" action="{{ url_for('teacher.group_delete', group_id=g.id) }}" onsubmit="return confirm('¿Eliminar grupo?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white text-sm">Eliminar</button>
            </form>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar grupo</summary>
            <form method="post" action="{{ url_for('teacher.group_update', group_id=g.id) }}" class="mt-2 grid md:grid-cols-3 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" value="{{ g.name }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" value="{{ g.grade or '' }}">
              <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button></div>
            </form>
          </details>

          <div class="mt-3">
            <div class="text-sm text-emerald-200/80 mb-2">Estudiantes ({{ g.students|length }})</div>
            <div class="flex flex-wrap gap-2">
              {% for s in g.students %}
                <form method="post" action="{{ url_for('teacher.group_remove_student', group_id=g.id) }}" onsubmit="return confirm('¿Quitar del grupo?')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="student_id" value="{{ s.id }}">
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-800/50 border border-emerald-700/50 text-sm">
                    {{ s.name }} <button title="Remover" class="text-red-300">✕</button>
                  </span>
                </form>
              {% else %}
                <div class="text-emerald-200/70 text-sm">Sin estudiantes aún.</div>
              {% endfor %}
            </div>

            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">Añadir estudiante</summary>
              <form method="post" action="{{ url_for('teacher.group_add_student', group_id=g.id) }}" class="mt-2 flex items-center gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="student_id" placeholder="ID de usuario (estudiante)">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Añadir</button>
              </form>
            </details>

            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">Asignar módulo a este grupo</summary>
              <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_type" value="group">
                <input type="hidden" name="target_id" value="{{ g.id }}">
                <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                  <option value="">Módulo</option>
                  {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
                </select>
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
              </form>
            </details>

            {% set group_assigns = g.module_assignments %}
            {% if group_assigns %}
              <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
              <div class="mt-1 flex flex-col gap-2">
                {% for ma in group_assigns %}
                  <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¿Eliminar asignación?')" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                      <div>{{ ma.module.title }}</div>
                      <button class="text-red-300">Quitar</button>
                    </div>
                  </form>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No tienes grupos aún.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Estudiantes (editar stats) ===== #}
  <a id="students"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Estudiantes</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for s in students %}
        {% set p = s.profile %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="font-semibold text-emerald-100 mb-1">{{ s.name }}</div>
          <form method="post" action="{{ url_for('teacher.student_edit_stats', user_id=s.id) }}" class="grid grid-cols-2 gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label class="text-xs">Crédito <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="credit_score" value="{{ (p.credit_score if p else 650) }}"></label>
            <label class="text-xs">Cash $ <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="cash_balance" value="{{ (p.cash_balance if p else 500) }}"></label>
            <label class="text-xs">Salario $/mes <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="salary_monthly" value="{{ (p.salary_monthly if p else 1200) }}"></label>
            <label class="text-xs flex items-center gap-2 mt-5"><input type="checkbox" name="has_car" {{ 'checked' if p and p.has_car else '' }}> Tiene carro</label>
            <label class="text-xs">Pago carro $/mes <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="car_payment_monthly" value="{{ (p.car_payment_monthly if p else 0) }}"></label>
            <label class="text-xs">Nivel <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="level" value="{{ (p.level if p else 1) }}"></label>
            <label class="text-xs">XP <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="xp" value="{{ (p.xp if p else 0) }}"></label>
            <label class="text-xs">Energía <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="energy" value="{{ (p.energy if p else 100) }}"></label>
            <div class="col-span-2 mt-2"><button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Guardar</button></div>
          </form>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Asignar módulo a este estudiante</summary>
            <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="target_type" value="student">
              <input type="hidden" name="target_id" value="{{ s.id }}">
              <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                <option value="">Módulo</option>
                {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
              </select>
              <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
            </form>
          </details>

          {% if s.module_assignments %}
            <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
            <div class="mt-1 flex flex-col gap-2">
              {% for ma in s.module_assignments %}
                <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¿Eliminar asignación?')" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                    <div>{{ ma.module.title }}</div>
                    <button class="text-red-300">Quitar</button>
                  </div>
                </form>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay estudiantes en tus grupos.</div>
      {% endfor %}
    </div>
  </div>
</div>

{# ==================== SCRIPT: Visual JSON editors ==================== #}
<script>
/* Small helper to create DOM nodes */
const h = (tag, attrs = {}, children = []) => {
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') el.className = v;
    else if (k === 'checked' && v) el.checked = true;
    else el.setAttribute(k, v);
  }
  for (const c of [].concat(children)) {
    if (c == null) continue;
    if (typeof c === 'string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  }
  return el;
};

/* ===== CREATE editor ===== */
(function initCreateEditor(){
  const form = document.querySelector('form[action="{{ url_for("teacher.activity_create") }}"]');
  if (!form) return;

  const typeSel   = document.getElementById('create-type');
  const hidden    = document.getElementById('create-content-json');

  const quizBox   = document.getElementById('create-quiz-editor');
  const qList     = document.getElementById('create-quiz-questions');
  const addQBtn   = document.getElementById('btn-create-add-question');

  const scnBox    = document.getElementById('create-scenario-editor');
  const scnPrompt = document.getElementById('create-scn-prompt');
  const scnList   = document.getElementById('create-scn-options');
  const addOptBtn = document.getElementById('btn-create-add-option');
  const presetSel = document.getElementById('create-scn-preset');
  const insertPresetBtn = document.getElementById('btn-create-insert-preset');

  // Show relevant editor for the selected type
  const setMode = (t) => {
    quizBox.classList.toggle('hidden', t !== 'quiz');
    scnBox.classList.toggle('hidden',  t !== 'scenario');
  };
  setMode(typeSel.value);
  typeSel.addEventListener('change', () => setMode(typeSel.value));

  // Build option row
  // Build option row (CREATE)
function makeOptionRow({label='', correct=false, delta=0}={}, forQuiz=false){
  const row = h('div', { class:'option-row grid grid-cols-12 gap-2 items-center' });

  // Text
  const txt = h('input', {
    type:'text',
    class:'col-span-6 rounded bg-slate-900 border border-slate-700 px-3 py-2',
    placeholder:'Option text',
    value:label
  });

  // Number (delta or just placeholder for quiz)
  const num = h('input', {
    type:'number', step:'1',
    class:'col-span-2 rounded bg-slate-900 border border-slate-700 px-3 py-2 text-right',
    placeholder: forQuiz ? '0' : 'Δ',
    value: delta ?? 0
  });

  // Correct checkbox (only for quiz)
  let correctWrap=null, correctCb=null;
  if (forQuiz){
    correctCb = h('input', { type:'checkbox', ...(correct ? { checked:true } : {}) });
    correctWrap = h(
      'label',
      { class:'col-span-3 flex items-center gap-2 text-sm text-emerald-100 whitespace-nowrap' },
      [correctCb, 'Correct answer']
    );
  } else {
    // spacer to keep delete aligned on non-quiz rows
    correctWrap = h('div', { class:'col-span-3' });
  }

  // Delete
  const del = h(
    'button',
    { type:'button',
      class:'col-span-1 justify-self-end h-9 px-3 rounded bg-rose-700 hover:bg-rose-600 text-white text-sm'
    },
    ['✕']
  );
  del.addEventListener('click', () => row.remove());

  row.append(txt, num, correctWrap, del);

  // Value extractor
  row._get = () => ({ label: txt.value.trim(), delta: Number(num.value || 0), correct: !!correctCb?.checked });
  return row;
}


  // Build question block
  function makeQuestionBlock(init=null){
    const box = h('div', { class:'rounded border border-slate-700 p-3 bg-slate-900/40' });
    const head = h('div', { class:'flex items-center justify-between mb-2' }, [
      h('div', { class:'text-sm font-medium text-emerald-100' }, ['Question']),
      h('div', { class:'flex items-center gap-2' }, [
        h('button', { type:'button', class:'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-xs js-add' }, ['+ option']),
        h('button', { type:'button', class:'px-2 py-1 rounded bg-rose-700 hover:bg-rose-600 text-white text-xs js-del' }, ['Remove'])
      ])
    ]);
    const prompt = h('input', { type:'text', class:'w-full rounded bg-slate-900 border border-slate-700 px-3 py-2 js-prompt', placeholder:'Question text' });
    const pts    = h('input', { type:'number', step:'1', class:'w-36 rounded bg-slate-900 border border-slate-700 px-3 py-2 mt-2 js-pts', placeholder:'Max points' });
    const list   = h('div', { class:'mt-2 space-y-2 js-list' });

    box.append(head, prompt, pts, list);

    const addBtn = head.querySelector('.js-add');
    const delBtn = head.querySelector('.js-del');
    addBtn.addEventListener('click', () => list.appendChild(makeOptionRow({}, true)));
    delBtn.addEventListener('click', () => box.remove());

    if (init){
      prompt.value = init.prompt || init.text || '';
      pts.value = init.max_points ?? 0;
      (init.options || []).forEach(o => list.appendChild(makeOptionRow({label: o.text || o.label || '', correct: !!o.correct}, true)));
    } else {
      addBtn.click();
    }

    box._get = () => ({
      prompt: prompt.value.trim(),
      max_points: Number(pts.value || 0),
      options: [...list.children].map(r => {
        const v = r._get?.() || {};
        return { text: v.label || '', correct: !!v.correct };
      })
    });
    return box;
  }

  // Wire up buttons (create)
  addQBtn?.addEventListener('click', () => qList.appendChild(makeQuestionBlock()));
  addOptBtn?.addEventListener('click', () => scnList.appendChild(makeOptionRow({}, false)));
  insertPresetBtn?.addEventListener('click', () => {
    if (!presetSel.value) return;
    try { const o = JSON.parse(presetSel.value); scnList.appendChild(makeOptionRow({label:o.label, delta:o.delta}, false)); } catch(e){}
  });

  // Serialize JSON on submit
  form.addEventListener('submit', () => {
    const t = typeSel.value;
    let payload = {};
    if (t === 'quiz'){
      const questions = [...qList.children].map(b => b._get?.()).filter(Boolean);
      payload = { questions };
    } else if (t === 'scenario'){
      const options = [...scnList.children].map(r => r._get?.()).filter(Boolean);
      payload = {
        prompt: scnPrompt.value.trim(),
        options: options.map(o => ({ label:o.label, delta: Number(o.delta || 0) }))
      };
    } else {
      payload = { body: "" };
    }
    hidden.value = JSON.stringify(payload);
  });
})();
</script>

<script>
/* ===== EDIT editors (per activity) ===== */
(function initEditEditors(){
  const mounts = document.querySelectorAll('.content-editor-mount');
  if (!mounts.length) return;

  mounts.forEach(mount => {
    const type = (mount.getAttribute('data-atype') || 'text').trim();
    let data = {};
    try { data = JSON.parse(mount.getAttribute('data-initial') || '{}'); } catch(e){ data = {}; }

    const hidden = mount.previousElementSibling; // hidden input for this form
    const form   = mount.closest('form');

    if (type === 'quiz'){
      // Mini quiz editor
      const wrapper = h('div', { class:'space-y-3' });
      const top = h('div', { class:'flex items-center justify-between' }, [
        h('div', { class:'text-sm font-semibold text-emerald-200' }, ['Questions']),
        h('button', { type:'button', class:'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-sm js-add' }, ['+ Add question'])
      ]);
      const list = h('div', { class:'space-y-3 js-list' });
      wrapper.append(top, list);
      mount.appendChild(wrapper);

      const addQ = () => {
        const box = h('div', { class:'rounded border border-slate-700 p-3 bg-slate-900/40' });
        box.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium text-emerald-100">Question</div>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-xs js-add-opt">+ option</button>
              <button type="button" class="px-2 py-1 rounded bg-rose-700 hover:bg-rose-600 text-white text-xs js-del-q">Remove</button>
            </div>
          </div>
          <input type="text" class="w-full rounded bg-slate-900 border border-slate-700 px-3 py-2 js-prompt" placeholder="Question text">
          <input type="number" step="1" class="w-36 rounded bg-slate-900 border border-slate-700 px-3 py-2 mt-2 js-pts" placeholder="Max points">
          <div class="mt-2 space-y-2 js-opt-list"></div>
        `;
        const optList = box.querySelector('.js-opt-list');
        const addO = () => {
  const row = document.createElement('div');
  row.className = 'option-row grid grid-cols-12 gap-2 items-center';
  row.innerHTML = `
    <input type="text"
           class="col-span-6 rounded bg-slate-900 border border-slate-700 px-3 py-2"
           placeholder="Option text">
    <input type="number"
           class="col-span-2 rounded bg-slate-900 border border-slate-700 px-3 py-2 text-right"
           placeholder="0" value="0">
    <label class="col-span-3 flex items-center gap-2 text-sm text-emerald-100 whitespace-nowrap">
      <input type="checkbox"> Correct answer
    </label>
    <button type="button"
            class="col-span-1 justify-self-end h-9 px-3 rounded bg-rose-700 hover:bg-rose-600 text-white text-sm">
      ✕
    </button>
  `;
  row.querySelector('button').addEventListener('click', () => row.remove());
  optList.appendChild(row);
};

        box.querySelector('.js-add-opt').addEventListener('click', addO);
        box.querySelector('.js-del-q').addEventListener('click', () => box.remove());
        list.appendChild(box);
        return { box, addO, optList };
      };

      // Prefill with existing data
      const qs = (data.questions || []);
      if (qs.length === 0) {
        const { box, addO } = addQ(); addO();
      } else {
        qs.forEach(q => {
          const { box, addO, optList } = addQ();
          box.querySelector('.js-prompt').value = q.prompt || q.text || '';
          box.querySelector('.js-pts').value = q.max_points ?? 0;
          (q.options || []).forEach(o => {
            addO();
            const row = optList.lastElementChild;
            row.querySelectorAll('input')[0].value = (o.text || o.label || '');
            row.querySelector('input[type="checkbox"]').checked = !!o.correct;
          });
        });
      }

      top.querySelector('.js-add').addEventListener('click', () => { const { addO } = addQ(); addO(); });

      // Serialize on submit
      form.addEventListener('submit', () => {
        const questions = [...list.children].map(box => {
          const prompt = box.querySelector('.js-prompt').value.trim();
          const pts = Number(box.querySelector('.js-pts').value || 0);
          const options = [...box.querySelectorAll('.grid')].map(row => {
            const ins = row.querySelectorAll('input');
            const label = ins[0].value.trim();
            const correct = row.querySelector('input[type="checkbox"]').checked;
            return { text: label, correct };
          });
        return { prompt, max_points: pts, options };
        });
        hidden.value = JSON.stringify({ questions });
      });

    } else if (type === 'scenario'){
      // Scenario editor
      const wrap = h('div', { class:'space-y-2' });
      wrap.innerHTML = `
        <label class="block text-sm text-emerald-200">Prompt / Situation</label>
        <input type="text" class="w-full rounded bg-slate-900 border border-slate-700 px-3 py-2 js-prompt">
        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm font-semibold text-emerald-200">Options</div>
          <button type="button" class="px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600 text-white text-sm js-add">+ Add option</button>
        </div>
        <div class="mt-2 space-y-2 js-list"></div>
      `;
      mount.appendChild(wrap);
      const prompt = wrap.querySelector('.js-prompt');
      const list = wrap.querySelector('.js-list');
      const add = wrap.querySelector('.js-add');

      const addRow = (label='', delta=0) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center';
        row.innerHTML = `
          <input type="text" class="col-span-9 rounded bg-slate-900 border border-slate-700 px-3 py-2" placeholder="Option text" value="${label}">
          <input type="number" step="1" class="col-span-2 rounded bg-slate-900 border border-slate-700 px-3 py-2" placeholder="Δ" value="${delta}">
          <button type="button" class="col-span-1 px-2 py-2 rounded bg-rose-700 hover:bg-rose-600 text-white text-sm">✕</button>
        `;
        row.querySelector('button').addEventListener('click', () => row.remove());
        list.appendChild(row);
      };

      // Prefill
      prompt.value = data.prompt || '';
      (data.options || []).forEach(o => addRow(o.label || o.text || '', o.delta ?? 0));
      if (!data.options || !data.options.length) addRow();

      add.addEventListener('click', () => addRow());

      // Serialize on submit
      form.addEventListener('submit', () => {
        const options = [...list.children].map(r => {
          const ins = r.querySelectorAll('input');
          return { label: ins[0].value.trim(), delta: Number(ins[1].value || 0) };
        });
        hidden.value = JSON.stringify({ prompt: prompt.value.trim(), options });
      });

    } else {
      // Fallback for "text" or others
      form.addEventListener('submit', () => { hidden.value = JSON.stringify({ body: "" }); });
    }
  });
})();
</script>

{% endblock %}
