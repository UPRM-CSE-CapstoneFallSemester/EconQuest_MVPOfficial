{% extends 'teacher/layout.html' %}
{% block teacher_content %}

<div class="max-w-7xl mx-auto text-slate-900 dark:text-slate-100">

  <h1 class="text-2xl font-bold mb-4 text-emerald-400">Panel del docente</h1>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, msg in messages %}
          <div class="p-3 rounded {{ 'bg-emerald-900/30 text-emerald-200 border border-emerald-700/40' if category=='success' else 'bg-red-900/30 text-red-100 border border-red-700/40' }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# ===== M√≥dulos ===== #}
  <a id="modules"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">M√≥dulos</h2>

      {# Bot√≥n nuevo que va directo al UI del builder #}
      <a href="{{ url_for('teacher.module_new') }}"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-full
                bg-emerald-900/60 border border-emerald-500/60
                text-emerald-100 text-sm hover:bg-emerald-800 hover:border-emerald-400">
        <span class="text-xs">‚ñ∂</span>
        <span>Ôºã Crear m√≥dulo</span>
      </a>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for m in modules %}
        {% set lvl = m.level or 1 %}
        {% set act_count = m.activities.count() if m.activities is defined else 0 %}

        {% if lvl <= 2 %}
          {% set diff_label = "F√°cil" %}
          {% set diff_class = "bg-emerald-900/70 text-emerald-200 border border-emerald-500/60" %}
        {% elif lvl <= 4 %}
          {% set diff_label = "Intermedio" %}
          {% set diff_class = "bg-amber-900/70 text-amber-100 border border-amber-500/60" %}
        {% else %}
          {% set diff_label = "Avanzado" %}
          {% set diff_class = "bg-rose-900/70 text-rose-100 border border-rose-500/60" %}
        {% endif %}

        <div class="rounded-2xl bg-emerald-950/70 border border-emerald-800/70 p-4 flex flex-col gap-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-300/70">
                M√≥dulo #{{ m.id }}
              </div>
              <div class="text-lg font-semibold text-emerald-50">
                {{ m.title }}
              </div>
              <p class="mt-1 text-xs text-emerald-100/80 line-clamp-2">
                {{ m.summary or 'Sin descripci√≥n todav√≠a.' }}
              </p>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="px-2 py-1 rounded-full text-[11px]
                           {{ 'bg-emerald-900/70 text-emerald-300 border border-emerald-500/60' if m.is_published else 'bg-slate-900/70 text-slate-300 border border-slate-500/60' }}">
                {{ 'Publicado' if m.is_published else 'Borrador' }}
              </span>
              <span class="px-2 py-1 rounded-full text-[11px] {{ diff_class }}">
                Nivel {{ lvl }} ¬∑ {{ diff_label }}
              </span>
            </div>
          </div>

          <div class="flex items-center justify-between text-[11px] text-emerald-200/80 border-t border-emerald-800/70 pt-2">
            <div class="flex gap-3">
              <span>Actividades: {{ act_count }}</span>
              <span>XP sugerido m√≥dulo: {{ m.xp_reward or 0 }}</span>
            </div>

            <div class="flex items-center gap-2">
              {# Ver lista de actividades del m√≥dulo #}
              <a href="{{ url_for('teacher.activities_for_module', module_id=m.id) }}"
                 class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-900/70 border border-slate-600/70 text-xs hover:bg-slate-800">
                 Ver actividades
              </a>

              {# Editar m√≥dulo en el nuevo UI #}
              <a href="{{ url_for('teacher.module_edit', module_id=m.id) }}"
                 class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-700/80 border border-emerald-500/70 text-xs hover:bg-emerald-600">
                 Editar m√≥dulo
              </a>

              {# Eliminar m√≥dulo #}
              <form method="post"
                    action="{{ url_for('teacher.module_delete', module_id=m.id) }}"
                    onsubmit="return confirm('¬øEliminar m√≥dulo? Esto eliminar√° sus actividades.');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-rose-700/80 border border-rose-500/70 text-xs text-white hover:bg-rose-600">
                   Eliminar
                </button>
              </form>
            </div>
          </div>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay m√≥dulos a√∫n.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Actividades ===== #}
  <a id="activities"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Actividades</h2>

      {# Bot√≥n que abre el builder de actividades (similar al de m√≥dulos) #}
      {% if modules %}
        <a href="{{ url_for('teacher.activities_builder', module_id=modules[0].id) }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-full
                  bg-emerald-900/60 border border-emerald-500/60
                  text-emerald-100 text-sm hover:bg-emerald-800 hover:border-emerald-400">
          <span class="text-xs">‚ñ∂</span>
          <span>Ôºã Crear actividad</span>
        </a>
      {% else %}
        <span class="text-xs text-emerald-300/80">
          Crea primero un m√≥dulo para poder a√±adir actividades.
        </span>
      {% endif %}
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for a in recent_activities %}

        {% set lvl = a.position or 1 %}
        <div class="rounded-2xl bg-emerald-950/70 border border-emerald-800/70 p-4 flex flex-col gap-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-300/70">
                Actividad #{{ a.id }} ¬∑ {{ a.module.title if a.module else 'Sin m√≥dulo' }}
              </div>
              <div class="text-sm font-semibold text-emerald-50">
                {{ a.title }}
              </div>
              <p class="mt-1 text-xs text-emerald-100/80">
                Tipo {{ a.type or 'quiz' }} ¬∑ M√°x {{ a.max_points or 0 }} pts ¬∑ XP base {{ a.default_xp or 0 }}
              </p>
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="px-2 py-1 rounded-full text-[11px]
                           {{ 'bg-emerald-900/70 text-emerald-300 border border-emerald-500/60' if a.is_published else 'bg-slate-900/70 text-slate-300 border border-slate-500/60' }}">
                {{ 'Publicado' if a.is_published else 'Borrador' }}
              </span>
              <span class="px-2 py-1 rounded-full text-[11px] bg-slate-900/70 text-emerald-200 border border-slate-600/70">
                Orden {{ lvl }}
              </span>
            </div>
          </div>

          <details class="mt-2">
            <summary class="cursor-pointer text-emerald-300 text-xs">Editar actividad</summary>

            <form method="post" action="{{ url_for('teacher.activity_update', activity_id=a.id) }}" class="mt-2 grid md:grid-cols-2 gap-2 text-xs">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="title"
  value="{{ a.title }}"
  placeholder="T√≠tulo de la actividad">

<input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="type"
  value="{{ a.type }}"
  placeholder="Tipo (quiz, scenario o text)">

<input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="max_points"
  value="{{ a.max_points or '' }}"
  placeholder="Puntos m√°x. (ej. 100)">

<input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="position"
  value="{{ a.position or '' }}"
  placeholder="Orden de la actividad (ej. 1)">

<input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="attempt_limit"
  value="{{ a.attempt_limit or '' }}"
  placeholder="Intentos permitidos (ej. 3)">

<input
  class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
  name="default_xp"
  value="{{ a.default_xp or '' }}"
  placeholder="XP base (ej. 25)">

              <label class="text-sm flex items-center gap-2">
                <input type="checkbox" name="is_published" {{ 'checked' if a.is_published else '' }}> Publicada
              </label>

              <input type="hidden" name="content_json" id="edit-json-{{ a.id }}">

              <div
                class="content-editor-mount md:col-span-2"
                data-activity-id="{{ a.id }}"
                data-atype="{{ a.type }}"
                data-initial='{{ a.content_json | safe }}'>
              </div>

              <div class="md:col-span-2">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-xs">Guardar</button>
              </div>
            </form>

            <form method="post" action="{{ url_for('teacher.activity_delete', activity_id=a.id) }}" onsubmit="return confirm('¬øEliminar actividad?')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white text-xs">Eliminar</button>
            </form>
          </details>
        </div>

      {% else %}
        <div class="text-emerald-200/80">No hay actividades a√∫n.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Misiones (retos de progreso) ===== #}
  <a id="missions"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Misiones</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200 text-sm">‚ûï Crear misi√≥n</summary>
        <form method="post" action="{{ url_for('teacher.mission_create') }}" class="mt-3 grid md:grid-cols-2 gap-3 text-sm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
                 name="title" placeholder="T√≠tulo (ej. 'Sube al nivel 2')" required>

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700 md:col-span-2"
                 name="description" placeholder="Descripci√≥n corta">

          <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
                  name="condition_type" required>
            <option value="">Condici√≥n</option>
            <option value="reach_level">Llegar a un nivel</option>
            <option value="complete_any_module">Completar el primer m√≥dulo</option>
            <option value="complete_module">Completar m√≥dulo espec√≠fico (ID)</option>
          </select>

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
                 name="condition_value" placeholder="Nivel o ID de m√≥dulo (seg√∫n tipo)">

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
                 name="xp_reward" placeholder="XP recompensa" value="50">

          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700"
                 name="cash_reward" placeholder="Dinero recompensa (ej. 100)">

          <label class="text-xs flex items-center gap-2">
            <input type="checkbox" name="is_active" checked> Activa
          </label>

          <div class="md:col-span-2">
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Crear misi√≥n</button>
          </div>
        </form>
      </details>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for m in missions %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4 text-sm">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ m.title }}</div>
              <div class="text-xs text-emerald-200/80 mt-1">{{ m.description or '' }}</div>
              <div class="mt-2 text-xs text-emerald-200/80">

                {% if m.condition_type == 'reach_level' %}
                  Llegar al nivel {{ m.condition_value }}
                {% elif m.condition_type == 'complete_any_module' %}
                  Completar el primer m√≥dulo
                {% elif m.condition_type == 'complete_module' %}
                  Completar el m√≥dulo #{{ m.condition_value }}
                {% else %}
                  Condici√≥n especial ({{ m.condition_type }})
                {% endif %}
              </div>
              <div class="mt-1 text-xs text-emerald-200/80">
                Recompensa:
                {% if m.xp_reward %}‚≠ê {{ m.xp_reward }} XP{% endif %}
                {% if m.cash_reward %} ¬∑ üíµ ${{ '%.2f'|format(m.cash_reward) }}{% endif %}
              </div>
            </div>
            <span class="px-2 py-1 rounded-full text-[11px]
                         {{ 'bg-emerald-900/70 text-emerald-300 border border-emerald-500/60' if m.is_active else 'bg-slate-900/70 text-slate-300 border border-slate-500/60' }}">
              {{ 'Activa' if m.is_active else 'Inactiva' }}
            </span>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-xs">Editar misi√≥n</summary>
            <form method="post" action="{{ url_for('teacher.mission_update', mission_id=m.id) }}" class="mt-2 grid md:grid-cols-2 gap-2 text-xs">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

              <input class="px-2 py-1 rounded bg-slate-900 border border-slate-700"
                     name="title" value="{{ m.title }}">

              <input class="px-2 py-1 rounded bg-slate-900 border border-slate-700 md:col-span-2"
                     name="description" value="{{ m.description or '' }}">

              <select class="px-2 py-1 rounded bg-slate-900 border border-slate-700"
                      name="condition_type">
                <option value="reach_level" {{ 'selected' if m.condition_type=='reach_level' else '' }}>Llegar a un nivel</option>
                <option value="complete_any_module" {{ 'selected' if m.condition_type=='complete_any_module' else '' }}>Completar primer m√≥dulo</option>
                <option value="complete_module" {{ 'selected' if m.condition_type=='complete_module' else '' }}>Completar m√≥dulo espec√≠fico</option>
              </select>

              <input class="px-2 py-1 rounded bg-slate-900 border border-slate-700"
                     name="condition_value" value="{{ m.condition_value or '' }}"
                     placeholder="Nivel o m√≥dulo id">

              <input class="px-2 py-1 rounded bg-slate-900 border border-slate-700"
                     name="xp_reward" value="{{ m.xp_reward or 0 }}">

              <input class="px-2 py-1 rounded bg-slate-900 border border-slate-700"
                     name="cash_reward" value="{{ m.cash_reward or 0 }}">

              <label class="flex items-center gap-2">
                <input type="checkbox" name="is_active" {{ 'checked' if m.is_active else '' }}> Activa
              </label>

              <div class="md:col-span-2 mt-1">
                <button class="px-3 py-1 rounded bg-emerald-600 text-white text-xs">Guardar</button>
              </div>
            </form>

            <form method="post" action="{{ url_for('teacher.mission_delete', mission_id=m.id) }}"
                  onsubmit="return confirm('¬øEliminar misi√≥n?')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-1 rounded bg-rose-600 text-white text-xs">Eliminar</button>
            </form>
          </details>
        </div>
      {% else %}
        <div class="text-emerald-200/80 text-sm">A√∫n no has creado misiones.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Grupos ===== #}
  <a id="groups"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Grupos</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">‚ûï Crear grupo</summary>
        <form method="post" action="{{ url_for('teacher.group_create') }}" class="mt-3 grid md:grid-cols-3 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" placeholder="Nombre (p. ej. Finanzas 10-A)" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" placeholder="Grado (9-12)">
          <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button></div>
        </form>
      </details>
    </div>

    <div class="space-y-3">
      {% for g in groups %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ g.name }}</div>
              <div class="text-xs text-emerald-200/80">Grado {{ g.grade or '-' }}</div>
            </div>
            <form method="post" action="{{ url_for('teacher.group_delete', group_id=g.id) }}" onsubmit="return confirm('¬øEliminar grupo?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white text-sm">Eliminar</button>
            </form>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar grupo</summary>
            <form method="post" action="{{ url_for('teacher.group_update', group_id=g.id) }}" class="mt-2 grid md:grid-cols-3 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" value="{{ g.name }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" value="{{ g.grade or '' }}">
              <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button></div>
            </form>
          </details>

          <div class="mt-3">
            <div class="text-sm text-emerald-200/80 mb-2">Estudiantes ({{ g.students|length }})</div>
            <div class="flex flex-wrap gap-2">
              {% for s in g.students %}
                <form method="post" action="{{ url_for('teacher.group_remove_student', group_id=g.id) }}" onsubmit="return confirm('¬øQuitar del grupo?')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="student_id" value="{{ s.id }}">
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-800/50 border border-emerald-700/50 text-sm">
                    {{ s.name }} <button title="Remover" class="text-red-300">‚úï</button>
                  </span>
                </form>
              {% else %}
                <div class="text-emerald-200/70 text-sm">Sin estudiantes a√∫n.</div>
              {% endfor %}
            </div>

            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">A√±adir estudiante</summary>
              <form method="post" action="{{ url_for('teacher.group_add_student', group_id=g.id) }}" class="mt-2 flex items-center gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="student_id" placeholder="ID de usuario (estudiante)">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">A√±adir</button>
              </form>
            </details>

            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">Asignar m√≥dulo a este grupo</summary>
              <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_type" value="group">
                <input type="hidden" name="target_id" value="{{ g.id }}">
                <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                  <option value="">M√≥dulo</option>
                  {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
                </select>
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
              </form>
            </details>

            {% set group_assigns = g.module_assignments %}
            {% if group_assigns %}
              <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
              <div class="mt-1 flex flex-col gap-2">
                {% for ma in group_assigns %}
                  <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¬øEliminar asignaci√≥n?')" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                      <div>{{ ma.module.title }}</div>
                      <button class="text-red-300">Quitar</button>
                    </div>
                  </form>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No tienes grupos a√∫n.</div>
      {% endfor %}
    </div>
  </div>

  {# ===== Estudiantes (editar stats) ===== #}
  <a id="students"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Estudiantes</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for s in students %}
        {% set p = s.profile %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="font-semibold text-emerald-100 mb-1">{{ s.name }}</div>
          <form method="post" action="{{ url_for('teacher.student_edit_stats', user_id=s.id) }}" class="grid grid-cols-2 gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label class="text-xs">Cr√©dito <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="credit_score" value="{{ (p.credit_score if p else 650) }}"></label>
            <label class="text-xs">Cash $ <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="cash_balance" value="{{ (p.cash_balance if p else 500) }}"></label>
            <label class="text-xs">Nivel <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="level" value="{{ (p.level if p else 1) }}"></label>
            <label class="text-xs">XP <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="xp" value="{{ (p.xp if p else 0) }}"></label>
            <div class="col-span-2 mt-2"><button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Guardar</button></div>
          </form>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Asignar m√≥dulo a este estudiante</summary>
            <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="target_type" value="student">
              <input type="hidden" name="target_id" value="{{ s.id }}">
              <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                <option value="">M√≥dulo</option>
                {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
              </select>
              <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
            </form>
          </details>

          {% if s.module_assignments %}
            <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
            <div class="mt-1 flex flex-col gap-2">
              {% for ma in s.module_assignments %}
                <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¬øEliminar asignaci√≥n?')" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                    <div>{{ ma.module.title }}</div>
                    <button class="text-red-300">Quitar</button>
                  </div>
                </form>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay estudiantes en tus grupos.</div>
      {% endfor %}
    </div>
  </div>
</div>

{# ==================== SCRIPT: Visual JSON editors (solo EDIT) ==================== #}
<script>
/* Small helper to create DOM nodes */
const h = (tag, attrs = {}, children = []) => {
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === 'class') el.className = v;
    else if (k === 'checked' && v) el.checked = true;
    else el.setAttribute(k, v);
  }
  for (const c of [].concat(children)) {
    if (c == null) continue;
    if (typeof c === 'string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  }
  return el;
};

/* ===== EDIT editors (per activity) ===== */
(function initEditEditors(){
  const mounts = document.querySelectorAll('.content-editor-mount');
  if (!mounts.length) return;

  mounts.forEach(mount => {
    const type = (mount.getAttribute('data-atype') || 'text').trim();
    let data = {};
    try { data = JSON.parse(mount.getAttribute('data-initial') || '{}'); } catch(e){ data = {}; }

    const hidden = mount.previousElementSibling; // hidden input for this form
    const form   = mount.closest('form');

    if (type === 'quiz'){
      // Mini quiz editor
      const wrapper = h('div', { class:'space-y-3' });
      const top = h('div', { class:'flex items-center justify-between' }, [
        h('div', { class:'text-sm font-semibold text-emerald-200' }, ['Questions']),
        h('button', { type:'button', class:'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-sm js-add' }, ['+ Add question'])
      ]);
      const list = h('div', { class:'space-y-3 js-list' });
      wrapper.append(top, list);
      mount.appendChild(wrapper);

      const addQ = () => {
        const box = h('div', { class:'rounded border border-slate-700 p-3 bg-slate-900/40' });
        box.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium text-emerald-100">Question</div>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-xs js-add-opt">+ option</button>
              <button type="button" class="px-2 py-1 rounded bg-rose-700 hover:bg-rose-600 text-white text-xs js-del-q">Remove</button>
            </div>
          </div>
          <input type="text" class="w-full rounded bg-slate-900 border border-slate-700 px-3 py-2 js-prompt" placeholder="Question text">
          <input type="number" step="1" class="w-36 rounded bg-slate-900 border border-slate-700 px-3 py-2 mt-2 js-pts" placeholder="Max points">
          <div class="mt-2 space-y-2 js-opt-list"></div>
        `;
        const optList = box.querySelector('.js-opt-list');
        const addO = () => {
          const row = document.createElement('div');
          row.className = 'option-row grid grid-cols-12 gap-2 items-center';
          row.innerHTML = `
            <input type="text"
                   class="col-span-6 rounded bg-slate-900 border border-slate-700 px-3 py-2"
                   placeholder="Option text">
            <input type="number"
                   class="col-span-2 rounded bg-slate-900 border border-slate-700 px-3 py-2 text-right"
                   placeholder="0" value="0">
            <label class="col-span-3 flex items-center gap-2 text-sm text-emerald-100 whitespace-nowrap">
              <input type="checkbox"> Correct answer
            </label>
            <button type="button"
                    class="col-span-1 justify-self-end h-9 px-3 rounded bg-rose-700 hover:bg-rose-600 text-white text-sm">
              ‚úï
            </button>
          `;
          row.querySelector('button').addEventListener('click', () => row.remove());
          optList.appendChild(row);
        };

        box.querySelector('.js-add-opt').addEventListener('click', addO);
        box.querySelector('.js-del-q').addEventListener('click', () => box.remove());
        list.appendChild(box);
        return { box, addO, optList };
      };

      // Prefill with existing data
      const qs = (data.questions || []);
      if (qs.length === 0) {
        const { box, addO } = addQ(); addO();
      } else {
        qs.forEach(q => {
          const { box, addO, optList } = addQ();
          box.querySelector('.js-prompt').value = q.prompt || q.text || '';
          box.querySelector('.js-pts').value = q.max_points ?? 0;
          (q.options || []).forEach(o => {
            addO();
            const row = optList.lastElementChild;
            row.querySelectorAll('input')[0].value = (o.text || o.label || '');
            row.querySelector('input[type="checkbox"]').checked = !!o.correct;
          });
        });
      }

      top.querySelector('.js-add').addEventListener('click', () => { const { addO } = addQ(); addO(); });

      // Serialize on submit
      form.addEventListener('submit', () => {
        const questions = [...list.children].map(box => {
          const prompt = box.querySelector('.js-prompt').value.trim();
          const pts = Number(box.querySelector('.js-pts').value || 0);
          const options = [...box.querySelectorAll('.grid')].map(row => {
            const ins = row.querySelectorAll('input');
            const label = ins[0].value.trim();
            const correct = row.querySelector('input[type="checkbox"]').checked;
            return { text: label, correct };
          });
          return { prompt, max_points: pts, options };
        });
        hidden.value = JSON.stringify({ questions });
      });

    } else if (type === 'scenario'){
      // Scenario editor
      const wrap = h('div', { class:'space-y-2' });
      wrap.innerHTML = `
        <label class="block text-sm text-emerald-200">Prompt / Situation</label>
        <input type="text" class="w-full rounded bg-slate-900 border border-slate-700 px-3 py-2 js-prompt">
        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm font-semibold text-emerald-200">Options</div>
          <button type="button" class="px-2 py-1 rounded bg-emerald-700 hover:bg-emerald-600 text-white text-sm js-add">+ Add option</button>
        </div>
        <div class="mt-2 space-y-2 js-list"></div>
      `;
      mount.appendChild(wrap);
      const prompt = wrap.querySelector('.js-prompt');
      const list = wrap.querySelector('.js-list');
      const add = wrap.querySelector('.js-add');

      const addRow = (label='', delta=0) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-2 items-center';
        row.innerHTML = `
          <input type="text" class="col-span-9 rounded bg-slate-900 border border-slate-700 px-3 py-2" placeholder="Option text" value="${label}">
          <input type="number" step="1" class="col-span-2 rounded bg-slate-900 border border-slate-700 px-3 py-2" placeholder="Œî" value="${delta}">
          <button type="button" class="col-span-1 px-2 py-2 rounded bg-rose-700 hover:bg-rose-600 text-white text-sm">‚úï</button>
        `;
        row.querySelector('button').addEventListener('click', () => row.remove());
        list.appendChild(row);
      };

      // Prefill
      prompt.value = data.prompt || '';
      (data.options || []).forEach(o => addRow(o.label || o.text || '', o.delta ?? 0));
      if (!data.options || !data.options.length) addRow();

      add.addEventListener('click', () => addRow());

      // Serialize on submit
      form.addEventListener('submit', () => {
        const options = [...list.children].map(r => {
          const ins = r.querySelectorAll('input');
          return { label: ins[0].value.trim(), delta: Number(ins[1].value || 0) };
        });
        hidden.value = JSON.stringify({ prompt: prompt.value.trim(), options });
      });

    } else {
      // Fallback for "text" or others
      form.addEventListener('submit', () => { hidden.value = JSON.stringify({ body: "" }); });
    }
  });
})();
</script>

{% endblock %}
