{% extends 'teacher/layout.html' %}
{% block teacher_content %}

<div class="max-w-7xl mx-auto text-slate-900 dark:text-slate-100">

  <h1 class="text-2xl font-bold mb-4 text-emerald-400">Panel del docente</h1>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, msg in messages %}
          <div class="p-3 rounded {{ 'bg-emerald-900/30 text-emerald-200 border border-emerald-700/40' if category=='success' else 'bg-red-900/30 text-red-100 border border-red-700/40' }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ===== Módulos ===== -->
  <a id="modules"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Módulos</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear módulo</summary>
        <form method="post" action="{{ url_for('teacher.module_create') }}" class="mt-3 grid md:grid-cols-2 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" placeholder="Título" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="level" placeholder="Nivel (ej. 1)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="xp_reward" placeholder="XP (ej. 100)">
          <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published"> Publicado</label>
          <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="summary" placeholder="Resumen / objetivos"></textarea>
          <div class="md:col-span-2">
            <button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button>
          </div>
        </form>
      </details>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for m in modules %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ m.title }}</div>
              <div class="text-xs text-emerald-200/80">Nivel {{ m.level or 1 }} · +{{ m.xp_reward or 0 }} XP</div>
              <p class="mt-1 text-sm text-emerald-200/80">{{ m.summary or '' }}</p>
            </div>
            <div class="text-xs text-emerald-200/80">{{ 'Publicado' if m.is_published else 'Borrador' }}</div>
          </div>

          <!-- Editar / Eliminar (SIN forms anidados) -->
          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar</summary>

            <!-- UPDATE -->
            <form method="post" action="{{ url_for('teacher.module_update', module_id=m.id) }}" class="mt-2 grid md:grid-cols-2 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" value="{{ m.title }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="level" value="{{ m.level or '' }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="xp_reward" value="{{ m.xp_reward or '' }}">
              <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published" {{ 'checked' if m.is_published else '' }}> Publicado</label>
              <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="summary">{{ m.summary or '' }}</textarea>
              <div class="md:col-span-2 flex items-center gap-2">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button>
              </div>
            </form>

            <!-- DELETE (form aparte, hermano) -->
            <form method="post" action="{{ url_for('teacher.module_delete', module_id=m.id) }}" onsubmit="return confirm('¿Eliminar módulo? Esto eliminará sus actividades.')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white">Eliminar</button>
            </form>
          </details>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay módulos aún.</div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Actividades ===== -->
  <a id="activities"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Actividades</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear actividad</summary>
        <form method="post" action="{{ url_for('teacher.activity_create') }}" class="mt-3 grid md:grid-cols-2 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
            <option value="">Selecciona módulo</option>
            {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
          </select>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" placeholder="Título" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="type" placeholder="Tipo (quiz, scenario...)" value="quiz">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="max_points" placeholder="Puntos máx. (ej. 100)">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="position" placeholder="Orden (ej. 1)">
            <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="attempt_limit" placeholder="Attempt limit (e.g., 3)">
            <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="default_xp" placeholder="Default XP (e.g., 25)" value="25">

          <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published"> Publicada</label>
          <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="content_json" placeholder='Contenido JSON (opcional)'></textarea>
          <div class="md:col-span-2"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button></div>
        </form>
      </details>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for a in recent_activities %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="font-semibold text-emerald-100">{{ a.title }}</div>
          <div class="text-xs text-emerald-200/80">Tipo {{ a.type }} · Puntos {{ a.max_points or 0 }}</div>

          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar</summary>

            <!-- UPDATE -->
            <form method="post" action="{{ url_for('teacher.activity_update', activity_id=a.id) }}" class="mt-2 grid md:grid-cols-2 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="title" value="{{ a.title }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="type" value="{{ a.type }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="max_points" value="{{ a.max_points or '' }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="position" value="{{ a.position or '' }}">
                <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="attempt_limit" value="{{ a.attempt_limit or '' }}" placeholder="Attempt limit">
                <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="default_xp" value="{{ a.default_xp or '' }}" placeholder="Default XP">

              <label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_published" {{ 'checked' if a.is_published else '' }}> Publicada</label>
              <textarea class="md:col-span-2 px-3 py-2 rounded bg-slate-900 border border-slate-700" name="content_json">{{ a.content_json or '' }}</textarea>
              <div class="md:col-span-2">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button>
              </div>
            </form>

            <!-- DELETE (form aparte, hermano) -->
            <form method="post" action="{{ url_for('teacher.activity_delete', activity_id=a.id) }}" onsubmit="return confirm('¿Eliminar actividad?')" class="mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white">Eliminar</button>
            </form>
          </details>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay actividades aún.</div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Grupos (clases) ===== -->
  <a id="groups"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Grupos</h2>
      <details class="bg-emerald-900/30 rounded-xl px-4 py-2 border border-emerald-800/40">
        <summary class="cursor-pointer text-emerald-200">➕ Crear grupo</summary>
        <form method="post" action="{{ url_for('teacher.group_create') }}" class="mt-3 grid md:grid-cols-3 gap-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" placeholder="Nombre (p. ej. Finanzas 10-A)" required>
          <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" placeholder="Grado (9-12)">
          <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Crear</button></div>
        </form>
      </details>
    </div>

    <div class="space-y-3">
      {% for g in groups %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-semibold text-emerald-100">{{ g.name }}</div>
              <div class="text-xs text-emerald-200/80">Grado {{ g.grade or '-' }}</div>
            </div>
            <form method="post" action="{{ url_for('teacher.group_delete', group_id=g.id) }}" onsubmit="return confirm('¿Eliminar grupo?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="px-3 py-2 rounded bg-red-600 text-white text-sm">Eliminar</button>
            </form>
          </div>

          <!-- Editar grupo -->
          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Editar grupo</summary>
            <form method="post" action="{{ url_for('teacher.group_update', group_id=g.id) }}" class="mt-2 grid md:grid-cols-3 gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="name" value="{{ g.name }}">
              <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="grade" value="{{ g.grade or '' }}">
              <div class="md:col-span-3"><button class="px-3 py-2 rounded bg-emerald-600 text-white">Guardar</button></div>
            </form>
          </details>

          <!-- Alumnos -->
          <div class="mt-3">
            <div class="text-sm text-emerald-200/80 mb-2">Estudiantes ({{ g.students|length }})</div>
            <div class="flex flex-wrap gap-2">
              {% for s in g.students %}
                <form method="post" action="{{ url_for('teacher.group_remove_student', group_id=g.id) }}" onsubmit="return confirm('¿Quitar del grupo?')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="student_id" value="{{ s.id }}">
                  <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-800/50 border border-emerald-700/50 text-sm">
                    {{ s.name }} <button title="Remover" class="text-red-300">✕</button>
                  </span>
                </form>
              {% else %}
                <div class="text-emerald-200/70 text-sm">Sin estudiantes aún.</div>
              {% endfor %}
            </div>

            <!-- Añadir estudiante por ID (simple) -->
            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">Añadir estudiante</summary>
              <form method="post" action="{{ url_for('teacher.group_add_student', group_id=g.id) }}" class="mt-2 flex items-center gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="student_id" placeholder="ID de usuario (estudiante)">
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Añadir</button>
              </form>
            </details>

            <!-- Asignar módulo a este grupo -->
            <details class="mt-2">
              <summary class="cursor-pointer text-emerald-300 text-sm">Asignar módulo a este grupo</summary>
              <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_type" value="group">
                <input type="hidden" name="target_id" value="{{ g.id }}">
                <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                  <option value="">Módulo</option>
                  {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
                </select>
                <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
              </form>
            </details>

            <!-- Asignaciones activas a este grupo -->
            {% set group_assigns = g.module_assignments %}
            {% if group_assigns %}
              <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
              <div class="mt-1 flex flex-col gap-2">
                {% for ma in group_assigns %}
                  <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¿Eliminar asignación?')" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                      <div>{{ ma.module.title }}</div>
                      <button class="text-red-300">Quitar</button>
                    </div>
                  </form>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="text-emerald-200/80">No tienes grupos aún.</div>
      {% endfor %}
    </div>
  </div>

  <!-- ===== Estudiantes (editar stats) ===== -->
  <a id="students"></a>
  <div class="bg-emerald-900/20 rounded-2xl p-5 border border-emerald-800/40 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-emerald-200">Estudiantes</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      {% for s in students %}
        {% set p = s.profile %}
        <div class="rounded-xl bg-emerald-900/30 border border-emerald-800/40 p-4">
          <div class="font-semibold text-emerald-100 mb-1">{{ s.name }}</div>
          <form method="post" action="{{ url_for('teacher.student_edit_stats', user_id=s.id) }}" class="grid grid-cols-2 gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <label class="text-xs">Crédito <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="credit_score" value="{{ (p.credit_score if p else 650) }}"></label>
            <label class="text-xs">Cash $ <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="cash_balance" value="{{ (p.cash_balance if p else 500) }}"></label>
            <label class="text-xs">Salario $/mes <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="salary_monthly" value="{{ (p.salary_monthly if p else 1200) }}"></label>
            <label class="text-xs flex items-center gap-2 mt-5"><input type="checkbox" name="has_car" {{ 'checked' if p and p.has_car else '' }}> Tiene carro</label>
            <label class="text-xs">Pago carro $/mes <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="car_payment_monthly" value="{{ (p.car_payment_monthly if p else 0) }}"></label>
            <label class="text-xs">Nivel <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="level" value="{{ (p.level if p else 1) }}"></label>
            <label class="text-xs">XP <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="xp" value="{{ (p.xp if p else 0) }}"></label>
            <label class="text-xs">Energía <input class="w-full mt-1 px-2 py-1 rounded bg-slate-900 border border-slate-700" name="energy" value="{{ (p.energy if p else 100) }}"></label>
            <div class="col-span-2 mt-2"><button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Guardar</button></div>
          </form>

          <!-- Asignar módulo individual -->
          <details class="mt-3">
            <summary class="cursor-pointer text-emerald-300 text-sm">Asignar módulo a este estudiante</summary>
            <form method="post" action="{{ url_for('teacher.assign_module') }}" class="mt-2 flex items-center gap-2 flex-wrap">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="target_type" value="student">
              <input type="hidden" name="target_id" value="{{ s.id }}">
              <select class="px-3 py-2 rounded bg-slate-900 border border-slate-700" name="module_id" required>
                <option value="">Módulo</option>
                {% for m in modules %}<option value="{{ m.id }}">{{ m.title }}</option>{% endfor %}
              </select>
              <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Asignar</button>
            </form>
          </details>

          {% if s.module_assignments %}
            <div class="mt-2 text-sm text-emerald-200/80">Asignaciones:</div>
            <div class="mt-1 flex flex-col gap-2">
              {% for ma in s.module_assignments %}
                <form method="post" action="{{ url_for('teacher.unassign_module', assign_id=ma.id) }}" onsubmit="return confirm('¿Eliminar asignación?')" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="px-3 py-2 rounded bg-emerald-800/40 border border-emerald-700/40 flex items-center justify-between">
                    <div>{{ ma.module.title }}</div>
                    <button class="text-red-300">Quitar</button>
                  </div>
                </form>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-emerald-200/80">No hay estudiantes en tus grupos.</div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
