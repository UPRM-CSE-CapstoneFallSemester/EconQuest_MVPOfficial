{% extends 'teacher/layout.html' %}
{% block teacher_content %}
<h1 class="text-2xl font-semibold text-emerald-200 mb-2">New MCQ Game</h1>
<p class="text-emerald-300 mb-6">Module: <span class="font-semibold">{{ module.title }}</span></p>

<form id="builderForm" method="post" class="space-y-4 max-w-4xl">
  {{ csrf_token() }}

  <div class="grid md:grid-cols-3 gap-4">
    <label class="block text-sm text-emerald-200">Activity title
      <input id="title" name="title" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2"
             placeholder="Car Buying 101">
    </label>

    <label class="block text-sm text-emerald-200">Position
      <input id="position" name="position" type="number" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2" value="0">
    </label>

    <label class="block text-sm text-emerald-200">Max points
      <input id="max_points" name="max_points" type="number" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2" value="100">
    </label>
  </div>

  <div class="grid md:grid-cols-3 gap-4">
    <label class="block text-sm text-emerald-200">XP on finish
      <input id="xp_on_finish" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2" type="number" value="120">
    </label>
    <label class="block text-sm text-emerald-200">Published?
      <input name="is_published" type="checkbox" class="ml-2 align-middle">
    </label>
  </div>

  <hr class="border-emerald-800/60 my-4">

  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold text-emerald-200">Questions</h2>
    <button type="button" id="addQuestionBtn"
            class="px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-white">+ Add question</button>
  </div>

  <div id="questionsWrap" class="space-y-4"></div>

  <!-- Preview + hidden JSON -->
  <div>
    <label class="block text-sm text-emerald-200 mb-1">Preview JSON</label>
    <textarea id="preview" class="w-full h-48 rounded bg-black/40 border border-emerald-800/60 p-2 font-mono text-emerald-200" readonly></textarea>
    <textarea id="content_json" name="content_json" class="hidden"></textarea>
  </div>

  <div class="flex gap-2">
    <button type="button" id="buildBtn" class="px-4 py-2 rounded-xl border border-emerald-700/70 hover:bg-emerald-900/30">Preview</button>
    <button id="saveBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white">Save activity</button>
    <a href="{{ url_for('teacher.activities_list', module_id=module.id) }}" class="px-4 py-2 rounded-xl border border-emerald-700/70 hover:bg-emerald-900/30">Cancel</a>
  </div>
</form>

<script>
(function(){
  let qCounter = 0;
  let questions = [];

  function newId(prefix){ return prefix + "_" + Math.random().toString(36).slice(2,8); }

  function addQuestion(){
    const q = { id: newId("q"), text: "", choices: [] };
    questions.push(q);
    render();
  }

  function removeQuestion(qid){
    questions = questions.filter(x => x.id !== qid);
    render();
  }

  function addChoice(qid){
    const q = questions.find(x => x.id === qid);
    q.choices.push({
      id: newId("c"),
      text: "",
      points: 0,
      explain: "",
      effects: { credit_score:0, cash_balance:0, salary_monthly:0, energy:0, xp:0 }
    });
    render();
  }

  function removeChoice(qid, idx){
    const q = questions.find(x => x.id === qid);
    q.choices.splice(idx,1);
    render();
  }

  function updateField(path, value){
    // path: ["q", qid, "text"] or ["c", qid, idx, "effects", "credit_score"]
    if(path[0] === "q"){
      const q = questions.find(x => x.id === path[1]);
      if(path[2] === "text") q.text = value;
    } else if(path[0] === "c"){
      const q = questions.find(x => x.id === path[1]);
      const c = q.choices[path[2]];
      if(path[3] === "text") c.text = value;
      else if(path[3] === "points") c.points = parseInt(value||0);
      else if(path[3] === "explain") c.explain = value;
      else if(path[3] === "effects"){
        c.effects[path[4]] = value === "" ? 0 : (path[4]==="cash_balance"||path[4]==="salary_monthly" ? parseFloat(value) : parseInt(value));
      }
    }
  }

  function render(){
    const wrap = document.getElementById("questionsWrap");
    wrap.innerHTML = "";
    questions.forEach((q, qi) => {
      const box = document.createElement("div");
      box.className = "p-4 rounded-xl bg-emerald-900/30 border border-emerald-800/60";
      box.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <label class="block text-sm text-emerald-200 flex-1">Question ${qi+1}
            <input class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2"
                   value="${q.text.replaceAll('"','&quot;')}" data-path="q|${q.id}|text">
          </label>
          <button type="button" data-act="remove_q" data-q="${q.id}"
                  class="mt-6 px-3 py-1 rounded bg-red-700/70 hover:bg-red-600 text-white">Remove</button>
        </div>
        <div class="mt-3 space-y-2" data-choices="${q.id}">
          ${q.choices.map((c,ci)=>`
            <div class="p-3 rounded bg-black/20 border border-emerald-800/40">
              <div class="grid md:grid-cols-2 gap-2">
                <label class="block text-sm text-emerald-200">Choice text
                  <input class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2"
                         value="${c.text.replaceAll('"','&quot;')}" data-path="c|${q.id}|${ci}|text">
                </label>
                <label class="block text-sm text-emerald-200">Points
                  <input type="number" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2"
                         value="${c.points}" data-path="c|${q.id}|${ci}|points">
                </label>
              </div>
              <label class="block text-sm text-emerald-200 mt-2">Explain (optional)
                <input class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-3 py-2"
                       value="${(c.explain||'').replaceAll('"','&quot;')}" data-path="c|${q.id}|${ci}|explain">
              </label>

              <div class="grid md:grid-cols-5 gap-2 mt-2">
                ${["credit_score","cash_balance","salary_monthly","energy","xp"].map(k=>`
                  <label class="block text-xs text-emerald-200">${k}
                    <input type="number" class="mt-1 w-full rounded bg-emerald-950/40 border border-emerald-800/60 px-2 py-1"
                           value="${c.effects[k]}" data-path="c|${q.id}|${ci}|effects|${k}">
                  </label>
                `).join("")}
              </div>

              <div class="mt-2">
                <button type="button" class="px-3 py-1 rounded bg-red-700/70 hover:bg-red-600 text-white"
                        data-act="remove_c" data-q="${q.id}" data-i="${ci}">Remove choice</button>
              </div>
            </div>
          `).join("")}
        </div>
        <button type="button" class="mt-2 px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-500 text-white"
                data-act="add_c" data-q="${q.id}">+ Add choice</button>
      `;
      wrap.appendChild(box);
    });
  }

  function buildJson(){
    const payload = {
      title: document.getElementById("title").value.trim() || "MCQ Game",
      kind: "mcq_sim",
      xp_on_finish: parseInt(document.getElementById("xp_on_finish").value || 0),
      questions: questions.map(q => ({
        id: q.id,
        text: q.text,
        choices: q.choices.map(c => ({
          id: c.id,
          text: c.text,
          points: parseInt(c.points||0),
          explain: c.explain || "",
          effects: {
            credit_score: parseInt(c.effects.credit_score||0),
            cash_balance: parseFloat(c.effects.cash_balance||0),
            salary_monthly: parseFloat(c.effects.salary_monthly||0),
            energy: parseInt(c.effects.energy||0),
            xp: parseInt(c.effects.xp||0)
          }
        }))
      }))
    };
    document.getElementById("preview").value = JSON.stringify(payload, null, 2);
    document.getElementById("content_json").value = JSON.stringify(payload);
  }

  // events
  document.getElementById("addQuestionBtn").addEventListener("click", addQuestion);
  document.getElementById("buildBtn").addEventListener("click", buildJson);
  document.getElementById("questionsWrap").addEventListener("input", (e)=>{
    const path = e.target.dataset.path;
    if(!path) return;
    updateField(path.split("|"), e.target.value);
  });
  document.getElementById("questionsWrap").addEventListener("click", (e)=>{
    const act = e.target.dataset.act;
    if(!act) return;
    if(act==="remove_q") removeQuestion(e.target.dataset.q);
    if(act==="add_c") addChoice(e.target.dataset.q);
    if(act==="remove_c") removeChoice(e.target.dataset.q, parseInt(e.target.dataset.i));
  });

  document.getElementById("saveBtn").addEventListener("click", (e)=>{
    buildJson(); // ensure hidden textarea is filled
    // let the form submit normally
  });

  // seed with one example question
  addQuestion();
  // and one default choice so el profe sabe por dÃ³nde empezar
  setTimeout(()=>{ addChoice(questions[0].id); }, 0);
})();
</script>
{% endblock %}
