{% extends 'student/layout.html' %}
{% block student_content %}
<style>
  /* === Fondo y layout general === */
  body, main, .content, .page-bg {
    background: #041b15 !important;
  }

  .module-detail {
    color: #e6f7f1;
    max-width: 1100px;
    margin: 0 auto;
    padding-bottom: 2.5rem;
  }

  .module-detail h1 {
    color: #d6fff4;
    font-weight: 700;
  }

  /* === Card del header del m√≥dulo === */
  .module-header-card {
    border-radius: 20px;
    padding: 18px 20px;
    background:
      radial-gradient(circle at top left, rgba(16,185,129,.25), transparent 55%),
      linear-gradient(135deg, rgba(6,32,27,.98), rgba(3,17,15,.98));
    border: 1px solid rgba(16,185,129,.35);
    box-shadow: 0 14px 34px rgba(0,0,0,.55);
  }

  .module-detail .pill {
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.5);
    background:rgba(15,23,42,.9);
    color:#e5fef7;
  }
  .pill-soft {
    border-color:rgba(16,185,129,.55);
    background:rgba(5,46,38,.9);
    color:#bbf7d0;
  }
  .pill-danger {
    border-color:rgba(248,113,113,.65);
    background:rgba(69,10,10,.96);
    color:#fecaca;
  }

  /* === Card de contenido del m√≥dulo === */
  .module-content-card{
    border-radius: 20px;
    padding: 18px 20px;
    background: linear-gradient(180deg, rgba(7,38,32,.98), rgba(5,26,22,.98));
    border: 1px solid rgba(16,185,129,.25);
    box-shadow: 0 12px 30px rgba(0,0,0,.45);
  }

  .module-section-title{
    font-size: .8rem;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: rgba(110, 231, 183, .85);
    margin-bottom: .75rem;
  }

  /* Imagen responsive: siempre cabe, sin cortarse feo */
  .module-image-wrap{
    width: 100%;
    max-height: 380px;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(15,118,110,.7);
    background: radial-gradient(circle at center, rgba(6,95,70,.35), #020617);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .module-image-wrap img{
    width: 100%;
    height: 100%;
    max-height: 380px;
    object-fit: contain; /* se ve completa */
  }

  .module-img-caption{
    font-size: .7rem;
    color: rgba(226,232,240,.75);
    margin-top: .3rem;
  }

  /* Tip / nota */
  .tip-box{
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(6,78,59,.9);
    border: 1px solid rgba(45,212,191,.6);
  }
  .tip-title{
    font-size: .85rem;
    font-weight: 600;
    display:flex;
    align-items:center;
    gap:.4rem;
    color:#d1fae5;
  }
  .tip-text{
    font-size:.8rem;
    margin-top:.25rem;
    color: rgba(209,250,229,.9);
  }

  /* Checklist */
  .checklist-title{
    font-size:.75rem;
    font-weight:600;
    color:#6ee7b7;
    margin-bottom:.25rem;
  }

  /* === Actividades === */
  .module-detail .activity-card {
    border-radius: 18px;
    padding: 16px;
    background: linear-gradient(180deg, rgba(11,47,40,.92), rgba(7,28,26,.92));
    border: 1px solid rgba(16,185,129,.22);
    box-shadow: 0 12px 32px rgba(0,0,0,.38), inset 0 0 40px rgba(16,185,129,.05);
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .module-detail .activity-card:hover {
    transform: translateY(-2px);
    filter: brightness(1.05);
    box-shadow: 0 16px 36px rgba(0,0,0,.45), inset 0 0 46px rgba(16,185,129,.07);
  }
  .module-detail .activity-title { color:#d6fff4; font-weight:600; }
  .module-detail .activity-meta {
    font-size:12px; color:#a7c6be; opacity:.9; margin-top:2px;
  }

  .module-detail .btn {
    display:inline-block; margin-top:12px; background:#10b981; color:#06281f;
    font-weight:700; padding:.55rem 1rem; border-radius:12px;
    box-shadow:0 8px 18px rgba(16,185,129,.25);
    transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    text-decoration:none; font-size:13px;
  }
  .module-detail .btn:hover {
    transform:translateY(-1px);
    filter:brightness(1.05);
    box-shadow:0 10px 22px rgba(16,185,129,.32);
  }

  .module-detail .btn-locked {
    background:rgba(30,64,175,.15);
    color:#bfdbfe;
    border:1px solid rgba(59,130,246,.65);
    box-shadow:none;
    cursor:not-allowed;
  }
  .module-detail .btn-locked:hover {
    transform:none;
    filter:none;
    box-shadow:none;
  }

  .module-detail .lock-banner {
    border-radius:14px;
    padding:10px 12px;
    background:rgba(120,53,15,.95);
    border:1px solid rgba(234,179,8,.65);
    font-size:12px;
    color:#fef3c7;
  }
</style>

{% set my_level = (profile.level if profile is defined and profile.level is not none else 1) %}
{% set required_level = (module.level if module.level is not none else 1) %}
{% set module_has_level = (module.level is not none) %}
{% set locked = module_has_level and (my_level < required_level) %}

<div class="module-detail space-y-6">

  {# === HEADER DEL M√ìDULO === #}
  <div class="module-header-card flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
    <div>
      <div class="text-[11px] uppercase tracking-wide text-emerald-300/70 mb-1">
        M√≥dulo
      </div>
      <h1 class="text-2xl font-semibold mb-2">{{ module.title }}</h1>
      {% if module.summary %}
        <p class="text-sm text-emerald-100/80 max-w-xl">
          {{ module.summary }}
        </p>
      {% endif %}
    </div>

    <div class="flex flex-col items-start md:items-end gap-2 text-xs">
      <div class="flex flex-wrap gap-2">
        <span class="pill pill-soft">
          ‚≠ê Tu nivel: {{ my_level }}
        </span>
        {% if module_has_level %}
          <span class="pill {{ 'pill-danger' if locked else 'pill-soft' }}">
            üéØ Nivel requerido m√≥dulo: {{ required_level }}
          </span>
        {% endif %}
        <span class="pill">
          üß© Actividades: {{ activities|length }}
        </span>
        <span class="pill">
          XP sugerido m√≥dulo: {{ module.xp_reward or 0 }}
        </span>
      </div>
      {% if locked %}
        <div class="lock-banner mt-1">
          Este m√≥dulo est√° bloqueado hasta que alcances el nivel {{ required_level }}.
          Completa otras actividades para ganar XP y subir de nivel. üí™
        </div>
      {% endif %}
    </div>
  </div>

  {# === TEOR√çA DEL M√ìDULO (secciones del builder) === #}
  {% if module_sections %}
    <div class="module-content-card space-y-4">
      <div class="module-section-title">Contenido del m√≥dulo</div>

      {% for block in module_sections %}

        {# T√≠tulo / heading #}
        {% if block.type == 'heading' %}
          <h2 class="text-lg font-semibold text-emerald-100">
            {{ block.text }}
          </h2>

        {# P√°rrafo de texto #}
        {% elif block.type == 'paragraph' %}
          <p class="text-sm leading-relaxed text-emerald-100">
            {{ block.text }}
          </p>

        {# L√≠nea divisora #}
        {% elif block.type == 'divider' %}
          <hr class="border-emerald-800/60 my-3">

        {# Imagen (auto-fit, sin recortar) #}
        {% elif block.type == 'image' %}
          <div>
            <div class="module-image-wrap">
              <img
                src="{{ block.url }}"
                alt="{{ block.caption or 'Imagen del m√≥dulo' }}"
              >
            </div>
            {% if block.caption %}
              <div class="module-img-caption">
                {{ block.caption }}
              </div>
            {% endif %}
          </div>

        {# Tip / nota #}
        {% elif block.type == 'tip' %}
          <div class="tip-box">
            <div class="tip-title">
              <span>{{ block.icon or 'üí°' }}</span>
              <span>{{ block.title or 'Tip' }}</span>
            </div>
            {% if block.text %}
              <p class="tip-text">
                {{ block.text }}
              </p>
            {% endif %}
          </div>

        {# Checklist #}
        {% elif block.type == 'checklist' %}
          {% set items = block["items"] if "items" in block else [] %}
          <div>
            {% if block.title %}
              <div class="checklist-title">
                {{ block.title }}
              </div>
            {% endif %}
            <ul class="list-disc list-inside space-y-1 text-sm text-emerald-100/90">
              {% for raw in items %}
                {# si vino todo en un solo string con \n, lo separamos #}
                {% set lines = raw.split('\n') %}
                {% for item in lines %}
                  {% if item %}
                    <li>{{ item }}</li>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </ul>
          </div>

        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {# === LISTA DE ACTIVIDADES === #}
  <div class="space-y-2 mt-6">
    <h2 class="text-sm font-semibold tracking-wide text-emerald-300/80 uppercase">
      Actividades del m√≥dulo
    </h2>

    <div class="grid gap-4 md:grid-cols-2">
      {% for a in activities %}
        <div class="activity-card {% if locked %}border-blue-700/60{% endif %}">
          <div class="activity-title flex items-center justify-between gap-2">
            <span>{{ a.title }}</span>
            {% if locked %}
              <span class="text-[11px] text-blue-200 flex items-center gap-1">
                üîí Nivel {{ required_level }}
              </span>
            {% endif %}
          </div>
          <div class="activity-meta">
            Tipo: {{ a.type or 'quiz' }}
            {% if a.max_points %} ¬∑ M√°x {{ a.max_points }} pts{% endif %}
            {% if a.position is not none %} ¬∑ Posici√≥n {{ a.position }}{% endif %}
          </div>

          <div class="mt-3 flex gap-2 items-center">
            {% if locked %}
              <span class="btn btn-locked">
                üîí Bloqueada ¬∑ Sube de nivel para jugar
              </span>
            {% else %}
              <a class="btn"
                 href="{{ url_for('student_ui.play_activity', activity_id=a.id) }}">
                Jugar actividad
              </a>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="text-emerald-300 md:col-span-2">
          Todav√≠a no hay actividades en este m√≥dulo.
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}
