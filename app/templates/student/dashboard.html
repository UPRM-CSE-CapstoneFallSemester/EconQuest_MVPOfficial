{% extends 'student/layout.html' %}
{% block student_content %}
<style>
  :root{
    --eq-header-h: 64px;
    --eq-left-gutter: 3rem;
  }

  /* Layout general */
  .stu-dashboard{
    color:#e6f7f1;
    padding-top: calc(var(--eq-header-h) + 10px);
  }
  @media (min-width: 768px){
    .guard-left{ padding-left: var(--eq-left-gutter); }
  }

  .stu-title{
    font-weight:700;
    letter-spacing:.2px;
    margin-top:.5rem;
  }

  /* ===== HUD / PLAYER CARD ===== */
  .hud-grid{
    display:grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr) minmax(0, 1.3fr);
    gap:16px;
  }
  @media (max-width:1024px){
    .hud-grid{
      grid-template-columns: minmax(0,1fr);
    }
  }

  .card-base{
    border-radius:18px;
    padding:14px 16px;
    background: radial-gradient(circle at top left, rgba(16,185,129,.28), transparent 55%),
                linear-gradient(145deg, rgba(6,32,27,.98), rgba(4,20,17,.98));
    border:1px solid rgba(16,185,129,.35);
    box-shadow:0 14px 34px rgba(0,0,0,.55), inset 0 0 40px rgba(16,185,129,.06);
  }

  .player-card{
    display:flex;
    gap:14px;
    align-items:stretch;
  }
  .player-avatar{
    flex-shrink:0;
    width:56px;
    height:56px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 20%, #bbf7d0, #059669);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:1.5rem;
    color:#022c22;
    box-shadow:0 0 0 3px rgba(16,185,129,.35);
  }
  .player-main{
    flex:1;
    min-width:0;
  }
  .player-name{
    font-size:.95rem;
    font-weight:700;
    color:#e6fffb;
  }
  .player-sub{
    font-size:.72rem;
    color:#a7f3d0;
    opacity:.85;
  }

  .pill-small{
    display:inline-flex;
    align-items:center;
    gap:5px;
    padding:3px 8px;
    border-radius:999px;
    font-size:.68rem;
    text-transform:uppercase;
    letter-spacing:.06em;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    color:#e5fef7;
  }
  .pill-small-success{
    border-color:rgba(16,185,129,.7);
    background:rgba(6,78,59,.9);
    color:#bbf7d0;
  }

  .xp-bar-wrap{
    margin-top:8px;
  }
  .xp-bar-label{
    display:flex;
    justify-content:space-between;
    font-size:.7rem;
    color:#a7c6be;
    margin-bottom:3px;
  }
  .xp-bar{
    position:relative;
    width:100%;
    height:8px;
    border-radius:999px;
    background:rgba(15,23,42,.9);
    overflow:hidden;
  }
  .xp-bar-fill{
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:linear-gradient(90deg,#22c55e,#a3e635,#22c55e);
    box-shadow:0 0 18px rgba(74,222,128,.7);
    transform-origin:left center;
  }

  .hud-stat{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .hud-stat-title{
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#a7f3d0;
  }
  .hud-stat-main{
    font-size:1.3rem;
    font-weight:700;
    color:#ecfeff;
  }
  .hud-stat-sub{
    font-size:.8rem;
    color:#bae6fd;
    opacity:.9;
  }

  /* ===== M√ìDULOS ===== */
  .mod-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap:16px;
  }
  .module-card{
    position:relative;
    border-radius:18px;
    padding:16px 18px;
    margin-top:.75rem;
    background: radial-gradient(circle at top left, rgba(16,185,129,.18), transparent 55%),
                linear-gradient(180deg, rgba(11,47,40,.92), rgba(5,25,22,.96));
    border:1px solid rgba(16,185,129,.28);
    box-shadow: 0 12px 32px rgba(0,0,0,.38), inset 0 0 40px rgba(16,185,129,.07);
    transition: transform .18s ease, filter .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .module-card:hover{
    transform: translateY(-3px);
    filter: brightness(1.06);
    box-shadow: 0 18px 40px rgba(0,0,0,.5), inset 0 0 52px rgba(16,185,129,.09);
    border-color:rgba(45,212,191,.7);
  }
  .module-title{
    font-weight:700;
    color:#d6fff4;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .module-badge{
    display:inline-flex;
    align-items:center;
    gap:4px;
    margin-top:6px;
    font-size:12px;
    color:#7ef2c5;
    background: rgba(16,185,129,.12);
    border:1px solid rgba(16,185,129,.25);
    padding:.2rem .55rem;
    border-radius:9999px;
  }
  .module-badge.is-draft{
    color:#facc6b;
    background: rgba(234,179,8,.08);
    border-color:rgba(234,179,8,.25);
  }
  .module-footer{
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
    font-size:.75rem;
    color:#a7c6be;
  }
  .module-tag{
    display:inline-flex;
    align-items:center;
    gap:4px;
  }

  /* ===== ACTIVIDADES ===== */
  .act-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:18px;
  }
  @media (max-width:1024px){
    .act-grid{ grid-template-columns:1fr; }
  }

  .activity-card{
    position:relative;
    border-radius:18px;
    padding:16px;
    background: radial-gradient(circle at top right, rgba(52,211,153,.16), transparent 55%),
                linear-gradient(180deg, rgba(10,37,33,.96), rgba(7,26,23,.98));
    border:1px solid rgba(16,185,129,.26);
    box-shadow: 0 12px 32px rgba(0,0,0,.38), inset 0 0 40px rgba(16,185,129,.05);
  }
  .activity-meta{
    font-size:12px;
    color:#a7c6be;
    opacity:.9;
    margin-bottom:6px;
  }
  .activity-title{
    font-size:.98rem;
    font-weight:600;
    color:#e0fdf4;
  }

  .activity-tag-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:6px;
    font-size:.72rem;
    color:#a7f3d0;
  }

  .btn-try{
    display:inline-flex;
    align-items:center;
    gap:6px;
    margin-top:12px;
    background:#10b981;
    color:#06281f;
    font-weight:700;
    padding:.55rem 1rem;
    border-radius:12px;
    box-shadow:0 8px 18px rgba(16,185,129,.25);
    transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    text-decoration:none;
    font-size:.85rem;
  }
  .btn-try:hover{
    transform: translateY(-1px);
    filter:brightness(1.05);
    box-shadow:0 10px 22px rgba(16,185,129,.32);
  }

  .empty-state{
    border-radius:16px;
    padding:16px 18px;
    background:rgba(15,23,42,.9);
    border:1px dashed rgba(148,163,184,.6);
    font-size:.9rem;
    color:#cbd5f5;
  }
</style>

{# datos del ‚Äújugador‚Äù si existen #}
{% set prof = profile if profile is defined else None %}
{% set my_level = prof.level if prof is not none and prof.level is not none else 1 %}
{% set my_xp = prof.xp if prof is not none and prof.xp is not none else 0 %}
{# cap sencillo 0‚Äì100 para la barra #}
{% set xp_percent = my_xp if my_xp <= 100 else 100 %}
{% set total_modules = modules|length if modules is defined and modules is not none else 0 %}
{% set total_activities = activities|length if activities is defined and activities is not none else 0 %}

<div class="stu-dashboard space-y-8">

  <!-- ===== HUD RPG / PLAYER ===== -->
  <section class="guard-left">
    <div class="hud-grid">

      <!-- Panel de jugador -->
      <div class="card-base player-card">
        <div class="player-avatar">
          {{ (current_user.first_name[0] if current_user.is_authenticated and current_user.first_name else 'E')|upper }}
        </div>
        <div class="player-main">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="player-name">
                {{ current_user.first_name or 'Estudiante' }}
              </div>
              <div class="player-sub">
                Aventurero econ√≥mico ¬∑ Nivel {{ my_level }}
              </div>
            </div>
            <span class="pill-small pill-small-success">
              ‚≠ê Nivel {{ my_level }}
            </span>
          </div>

          <div class="xp-bar-wrap">
            <div class="xp-bar-label">
              <span>XP actual</span>
              <span>{{ my_xp }} XP</span>
            </div>
            <div class="xp-bar">
              <div class="xp-bar-fill" style="transform:scaleX({{ (xp_percent/100.0) }})"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats: m√≥dulos -->
      <div class="card-base hud-stat">
        <div class="hud-stat-title">M√≥dulos activos</div>
        <div class="hud-stat-main">{{ total_modules }}</div>
        <div class="hud-stat-sub">
          {{ 'Historia principal y side quests' if total_modules else 'Tu profesor a√±adir√° m√≥dulos pronto.' }}
        </div>
      </div>

      <!-- Stats: actividades -->
      <div class="card-base hud-stat">
        <div class="hud-stat-title">Actividades disponibles</div>
        <div class="hud-stat-main">{{ total_activities }}</div>
        <div class="hud-stat-sub">
          {{ 'Completa actividades para ganar XP y recompensas.' if total_activities else 'Cuando haya actividades podr√°s verlas aqu√≠.' }}
        </div>
      </div>

    </div>
  </section>

  <!-- ===== M√ìDULOS ===== -->
  <section class="space-y-3 guard-left">
    <div class="flex items-center justify-between gap-2">
      <h2 class="stu-title text-xl">M√≥dulos disponibles</h2>
      {% if total_modules %}
        <span class="text-xs text-emerald-800">
          Escoge un m√≥dulo para ver su historia y actividades.
        </span>
      {% endif %}
    </div>

    <div class="mod-grid">
      {% if modules %}
        {% for m in modules %}
          <a
            href="{{ url_for('student_ui.module_detail', module_id=m.id) }}"
            class="module-card block no-underline cursor-pointer"
            aria-label="Abrir m√≥dulo {{ m.title }}"
          >
            <div class="module-title">
              {{ m.title }}
            </div>

            {% if m.summary %}
              <p class="mt-1 text-sm text-emerald-200/80 line-clamp-2">
                {{ m.summary }}
              </p>
            {% endif %}

            <div class="mt-2 flex items-center gap-2 text-xs">
              <span class="module-badge {{ '' if m.is_published else 'is-draft' }}">
                {{ 'Publicado' if m.is_published else 'Borrador' }}
              </span>
              {% if m.level %}
                <span class="module-badge">
                  üõ°Ô∏è Nivel {{ m.level }}
                </span>
              {% endif %}
              {% if m.xp_reward %}
                <span class="module-badge">
                  üí† +{{ m.xp_reward }} XP
                </span>
              {% endif %}
              <span class="ml-auto text-emerald-300/90 flex items-center gap-1">
                Explorar <span>‚Üí</span>
              </span>
            </div>

            <div class="module-footer">
              <span class="module-tag">
                üß© {{ m.activities.count() if m.activities is not none else 0 }} actividades
              </span>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          üé≤ A√∫n no tienes m√≥dulos asignados. Cuando tu profesor publique o asigne m√≥dulos, aparecer√°n aqu√≠
          como nuevas aventuras.
        </div>
      {% endif %}
    </div>
  </section>

  <!-- ===== ACTIVIDADES ===== -->
  <section class="space-y-3 guard-left">
    <div class="flex items-center justify-between gap-2">
      <h2 class="stu-title text-xl">Actividades r√°pidas</h2>
      {% if total_activities %}
        <span class="text-xs text-emerald-800">
          Elige una actividad para ganar XP y mejorar tu perfil financiero.
        </span>
      {% endif %}
    </div>

    {% if activities %}
      <div class="act-grid">
        {% for a in activities %}
          <div class="activity-card">
            <div class="activity-meta">
              {{ a.module.title if a.module else 'M√≥dulo' }}
              ¬∑ {{ a.type or 'texto' }}
              ¬∑ M√°x {{ a.max_points or 0 }} pts
            </div>
            <div class="activity-title">
              {{ a.title }}
            </div>

            <div class="activity-tag-row">
              <span>üèÖ XP base: {{ a.default_xp or a.max_points or 25 }}</span>
              {% if a.position is not none %}
                <span>Orden: {{ a.position }}</span>
              {% endif %}
            </div>

            <a class="btn-try" href="{{ url_for('student_ui.play_activity', activity_id=a.id) }}">
              ‚ñ∂ Jugar misi√≥n
            </a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        ‚öîÔ∏è Todav√≠a no hay misiones publicadas. En cuanto tu profesor active actividades,
        podr√°s completarlas aqu√≠ para ganar XP, dinero virtual y mejorar tu puntuaci√≥n de cr√©dito.
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

