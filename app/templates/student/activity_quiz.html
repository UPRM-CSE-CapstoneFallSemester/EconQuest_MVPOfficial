{% extends 'student/layout.html' %}
{% block student_content %}

<div class="max-w-3xl mx-auto">
  <h1 class="text-2xl font-bold text-emerald-800">{{ activity.title }}</h1>
  <p class="text-emerald-800 mt-1">Type: {{ activity.type or 'quiz' }}</p>

  {% if attempt_limit is not none %}
    <div class="mt-2 text-sm text-emerald-800">
      Attempts: {{ attempts_used }}/{{ attempt_limit }}
      {% if attempts_left is not none %} · Left: {{ attempts_left }}{% endif %}
    </div>
  {% endif %}

  {% if blocked %}
    <div class="mt-4 p-4 rounded bg-red-900/30 border border-red-800/40 text-red-100">
      You have reached the attempt limit for this activity.
    </div>
  {% else %}
    <form method="post" class="mt-4 space-y-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {# 1) Construimos questions dependiendo del formato #}
        {% if content.get('questions') or content.get('quiz') %}
          {# Formato normal de quiz (ya existente) #}
          {% set questions = (
              content.get('questions')
              or content.get('quiz', {}).get('questions')
              or []
          ) %}
        {% elif content.get('prompt') and content.get('options') %}
          {# Formato de scenario como el JSON que enseñaste #}
          {% set questions = [ {
            'text': content.prompt,
            'options': content.options
          } ] %}
        {% else %}
          {% set questions = [] %}
        {% endif %}


      {% for q in questions %}
        {% set q_idx = loop.index0 %}

        {# 2) Texto de la pregunta con múltiples llaves posibles #}
        {% set q_text = (
            (q.text if q is not string and q.text is defined else none)
            or (q.get('text') if q.get is defined else none)
            or (q.label if q is not string and q.label is defined else none)
            or (q.get('label') if q.get is defined else none)
            or (q.title if q is not string and q.title is defined else none)
            or (q.get('title') if q.get is defined else none)
            or ('Pregunta ' ~ loop.index)
        ) %}

        {# 3) Opciones: soporta 'options' o 'choices', objetos o strings #}
        {% set opts = (
            (q.options if q is not string and q.options is defined else none)
            or (q.get('options') if q.get is defined else none)
            or (q.get('choices') if q.get is defined else none)
            or []
        ) %}

        <div class="p-4 rounded-xl bg-emerald-900/30 border border-emerald-800/40">
          <div class="font-semibold text-emerald-100">
            {{ loop.index }}. {{ q_text }}
          </div>

          <div class="mt-2 space-y-2">
            {% for opt in opts %}
              {% if opt is string %}
                {% set val = loop.index0 %}
                {% set label = opt %}
              {% else %}
                {% set val = (
                  (opt.key if opt.key is defined else none)
                  or (opt.get('key') if opt.get is defined else none)
                  or loop.index0
                ) %}
                {% set label = (
                  (opt.label if opt.label is defined else none)
                  or (opt.get('label') if opt.get is defined else none)
                  or (opt.text if opt.text is defined else none)
                  or (opt.get('text') if opt.get is defined else none)
                  or (opt.title if opt.title is defined else none)
                  or (opt.get('title') if opt.get is defined else none)
                  or (opt.value if opt.value is defined else none)
                  or (opt.get('value') if opt.get is defined else none)
                  or ('Opción ' ~ loop.index)
                ) %}
              {% endif %}

              <label class="flex items-start gap-3 cursor-pointer">
                <input
                  type="radio"
                  name="q{{ q_idx }}"
                  value="{{ val }}"
                  required
                  class="mt-1"
                >
                <div class="text-emerald-100">{{ label }}</div>
              </label>
            {% endfor %}
          </div>

          {# --- DEBUG opcional: comenta/borra en producción ---
          <details class="mt-2 opacity-70"><summary>debug</summary>
            <pre class="text-xs">{{ q|tojson(indent=2) }}</pre>
          </details>
          #}
        </div>
      {% endfor %}

      <button class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white">Submit</button>
    </form>
  {% endif %}
</div>

{% endblock %}
